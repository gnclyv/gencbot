<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <title>Double Cyber Hands</title>
    <style>
        body { margin: 0; overflow: hidden; background: radial-gradient(circle, #000808, #000); }
        #input_video { position: absolute; visibility: hidden; }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); display: flex; justify-content: center; align-items: center; z-index: 1000;
        }
        button {
            padding: 15px 40px; font-size: 18px; background: none; border: 2px solid #ff00cc;
            color: #ff00cc; cursor: pointer; font-family: 'Courier New', monospace;
            box-shadow: 0 0 15px rgba(255, 0, 204, 0.3); transition: 0.3s;
        }
        button:hover { background: #ff00cc; color: #000; box-shadow: 0 0 30px #ff00cc; }
    </style>
</head>
<body>

    <div id="overlay"><button onclick="startSystem()">İki Əlli Sistemi Başlat</button></div>
    <video id="input_video" playsinline></video>

    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/build/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

    <script>
        const videoElement = document.getElementById('input_video');
        const overlay = document.getElementById('overlay');

        const scene = new THREE.Scene();
        const camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
        const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        camera.position.z = 8;

        // --- ƏL YARATMA FUNKSİYASI ---
        function createCyberHand(color) {
            const group = new THREE.Group();
            const joints = [];
            const jointGeo = new THREE.SphereGeometry(0.08, 8, 8);
            const jointMat = new THREE.MeshBasicMaterial({ color: color });
            
            for(let i=0; i<21; i++) {
                const joint = new THREE.Mesh(jointGeo, jointMat);
                group.add(joint);
                joints.push(joint);
            }

            const skeletonGeo = new THREE.BufferGeometry();
            const skeletonMat = new THREE.LineBasicMaterial({ color: color, transparent: true, opacity: 0.8 });
            const skeleton = new THREE.LineSegments(skeletonGeo, skeletonMat);

            const webGeo = new THREE.BufferGeometry();
            const webMat = new THREE.LineBasicMaterial({ color: color, transparent: true, opacity: 0.2 });
            const web = new THREE.LineSegments(webGeo, webMat);

            scene.add(group, skeleton, web);
            return { group, joints, skeleton, web, visible: false };
        }

        // İki əl yaradırıq: Biri neon yaşıl, biri neon çəhrayı
        const hand1 = createCyberHand(0x00ffcc); 
        const hand2 = createCyberHand(0xff00cc);
        const handsArray = [hand1, hand2];

        const connections = [
            [0,1],[1,2],[2,3],[3,4], [0,5],[5,6],[6,7],[7,8],
            [5,9],[9,10],[10,11],[11,12], [9,13],[13,14],[14,15],[15,16],
            [13,17],[17,18],[18,19],[19,20],[0,17]
        ];

        // --- MEDIAPIPE ---
        const hands = new Hands({
            locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
        });

        hands.setOptions({ 
            maxNumHands: 2, // BURADA 2 ƏL AKTİV EDİLDİ
            modelComplexity: 1, 
            minDetectionConfidence: 0.7,
            minTrackingConfidence: 0.7 
        });

        hands.onResults((results) => {
            // Əvvəlcə hər iki əli gizlət
            handsArray.forEach(h => {
                h.group.visible = h.skeleton.visible = h.web.visible = false;
            });

            if (results.multiHandLandmarks) {
                results.multiHandLandmarks.forEach((landmarks, index) => {
                    if (index < 2) {
                        const hand = handsArray[index];
                        hand.group.visible = hand.skeleton.visible = hand.web.visible = true;

                        const points = landmarks.map(p => 
                            new THREE.Vector3((p.x - 0.5) * -16, (p.y - 0.5) * -12, -p.z * 10)
                        );

                        // Oynaqlar
                        points.forEach((p, i) => hand.joints[i].position.copy(p));

                        // Karkas
                        const skelPoints = [];
                        connections.forEach(([a, b]) => skelPoints.push(points[a], points[b]));
                        hand.skeleton.geometry.setFromPoints(skelPoints);

                        // Bilək bağlantıları
                        const webPoints = [];
                        points.forEach((p, i) => { if(i !== 0) webPoints.push(points[0], p); });
                        hand.web.geometry.setFromPoints(webPoints);
                    }
                });
            }
        });

        async function startSystem() {
            overlay.style.display = 'none';
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            videoElement.srcObject = stream;
            const cameraHelper = new Camera(videoElement, {
                onFrame: async () => { await hands.send({image: videoElement}); },
                width: 1280, height: 720
            });
            cameraHelper.start();
        }

        function animate() {
            requestAnimationFrame(animate);
            renderer.render(scene, camera);
        }
        animate();

        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });
    </script>
</body>
</html>
